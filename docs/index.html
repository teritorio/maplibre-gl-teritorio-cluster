<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/teritorio.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:description" content="Allow visualization and interaction with all markers, even when superposed. Can display and interact with small cluster without the need to zoom or uncluster." />
  <title>MapLibre GL Teritorio Cluster</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.5.1/dist/maplibre-gl.css">
  <script src="https://unpkg.com/maplibre-gl@4.5.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@teritorio/maplibre-gl-teritorio-cluster/dist/teritorio.umd.production.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    html, body, #map { height: 100%; }
  </style>
</head>

<body>
  <div id="map"></div>
  <script type="module">
    const map = new maplibregl.Map({
      hash: true,
      container: "map",
      style: 'https://api.maptiler.com/maps/openstreetmap/style.json?key=GIAfARJO9HDgKceZRlGv'
    });

    map.addControl(new maplibregl.NavigationControl());

    map.on('load', async () => {
      let geojson = await fetch('https://maplibre.org/maplibre-gl-js/docs/assets/earthquakes.geojson', { method: 'GET' }).then(res => res.json())

      // add a clustered GeoJSON source for a sample set of earthquakes
      map.addSource('earthquakes', {
        'type': 'geojson',
        'data': geojson,
        'cluster': true,
        'clusterRadius': 80,
        'clusterMaxZoom': 22,
      })

      map.addLayer({
        'id': 'earthquake_label',
        'type': 'symbol',
        'source': 'earthquakes',
        'filter': ['!=', 'cluster', true],
        'layout': {
          'text-field': [
            'number-format',
            ['get', 'mag'],
            { 'min-fraction-digits': 1, 'max-fraction-digits': 1 }
          ],
          'text-font': ['Open Sans Semibold'],
          'text-size': 10
        },
        'paint': {
          'text-color': 'white'
        }
      });

      const teritorioCluster = new teritorio.TeritorioCluster(
        map,
        'earthquakes',
        {
          clusterRenderFn: clusterRender,
          markerRenderFn: markerRender,
          markerSize: 28,
          unfoldedClusterRenderFn: teritorio.unfoldedClusterRenderSmart,
          pinMarkerRenderFn: pinMarkerRender
        },
      )

      teritorioCluster.render()

      // Get feature click event
      teritorioCluster.addEventListener('click', (e) => {
        console.log(e.detail.selectedFeature)
      })
    })

    const pinMarkerRender = (coords, offset) => {
      return new maplibregl.Marker({
        scale: 1.3,
        color: '#f44336',
        anchor: 'bottom'
      })
        .setLngLat(coords)
        .setOffset(offset)
    }

    const markerRender = (element, feature, markerSize) => {
      element.textContent = feature.properties?.mag

      teritorio.buildCss(element, {
        'background-color': 'green',
        'border-radius': '100%',
        'justify-content': 'center',
        'align-items': 'center',
        'display': 'flex',
        'color': 'white',
        'width': `${markerSize}px`,
        'height': `${markerSize}px`,
        'cursor': 'pointer'
      });
    }

    const clusterRender = (element, props) => {
      element.innerHTML = props.point_count.toLocaleString();

      teritorio.buildCss(element, {
        'background-color': 'white',
        'border-radius': '100%',
        'border': '2px solid green',
        'justify-content': 'center',
        'align-items': 'center',
        'display': 'flex',
        'color': 'black',
        'width': `60px`,
        'height': `60px`,
        'cursor': 'pointer'
      });
    }
  </script>

</body>

</html>